version: '3.8'

services:
  # MinIO - Object Storage
  minio:
    image: minio/minio:latest
    container_name: labdropbox-minio
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - labdropbox-network

  # TiDB - Distributed SQL Database
  tidb:
    image: pingcap/tidb:latest
    container_name: labdropbox-tidb
    ports:
      - "4000:4000"  # MySQL protocol port
    command:
      - --store=mocktikv
      - --path=/tmp/tidb
    volumes:
      - tidb-data:/tmp/tidb
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "nc -zv 127.0.0.1 4000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - labdropbox-network

  # Redis - Caching Layer
  redis:
    image: redis:alpine
    container_name: labdropbox-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - labdropbox-network

  # Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: labdropbox-jaeger
    ports:
      - "16686:16686"  # Jaeger UI
      - "4318:4318"    # OTLP HTTP receiver
      - "14268:14268"  # Jaeger collector
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    networks:
      - labdropbox-network

  # LabDropbox Application
  app:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: labdropbox-app
    ports:
      - "8080:8080"
    environment:
      # Service configuration
      SERVICE_PORT: "8080"
      SERVICE_NAME: "labdropbox-service"
      CHUNK_SIZE_MB: "1"

      # MinIO configuration
      MINIO_ENDPOINT: "minio:9000"
      MINIO_ACCESS_KEY: "minioadmin"
      MINIO_SECRET_KEY: "minioadmin"
      MINIO_BUCKET_NAME: "labdropbox"
      MINIO_USE_SSL: "false"

      # TiDB configuration
      TIDB_HOST: "tidb"
      TIDB_PORT: "4000"
      TIDB_USER: "root"
      TIDB_PASSWORD: ""
      TIDB_DATABASE: "labdropbox"

      # Redis configuration
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ""
      REDIS_DB: "0"

      # Jaeger configuration
      JAEGER_ENDPOINT: "jaeger:4318"
    depends_on:
      minio:
        condition: service_healthy
      tidb:
        condition: service_started
      redis:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - labdropbox-network

volumes:
  minio-data:
  tidb-data:
  redis-data:

networks:
  labdropbox-network:
    driver: bridge
